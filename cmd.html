<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Machines Table</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    .nav-card { padding: 8px 12px; cursor: pointer; display: inline-block; margin: 4px; background: #eee; border-radius: 6px; }
    .nav-active { background: #333; color: #fff; }
    .table-wrapper { margin: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .table-title { padding: 10px; font-weight: bold; background: #f7f7f7; }
    .table-scroll { max-height: 400px; overflow-y: auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
    .empty-state { padding: 20px; text-align: center; color: #777; }
    .card { display: inline-block; margin: 10px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; }
    .label { display: block; margin-top: 6px; }
  </style>
</head>
<body>
  <div id="nav"></div>
  <h3 id="totalMachines">Total Machines: 0</h3>

  <!-- Stat cards -->
  <div>
    <div class="card" data-key="owned"><span id="owned">0</span><span class="label">Owned</span></div>
    <div class="card" data-key="demo"><span id="demo">0</span><span class="label">Demo</span></div>
    <div class="card" data-key="rented"><span id="rented">0</span><span class="label">Rented</span></div>
    <div class="card" data-key="active"><span id="active">0</span><span class="label">Active</span></div>
    <div class="card" data-key="breakdown"><span id="breakdown">0</span><span class="label">Breakdown</span></div>
    <div class="card" data-key="idle"><span id="idle">0</span><span class="label">Idle</span></div>
    <div class="card" data-key="moving"><span id="moving">0</span><span class="label">Moving</span></div>
    <div class="card" data-key="warranty"><span id="warranty">0</span><span class="label">Warranty</span></div>
    <div class="card" data-key="nonWarranty"><span id="nonWarranty">0</span><span class="label">Non Warranty</span></div>
    <div class="card" data-key="amc"><span id="amc">0</span><span class="label">AMC</span></div>
    <div class="card" data-key="nonAmc"><span id="nonAmc">0</span><span class="label">Non AMC</span></div>
  </div>

  <div id="machinesTable"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnHHfwRgKh_Ff1RNmIzf8MYZEMrFsyx2Q",
    authDomain: "shahi-stats-analytics-1.firebaseapp.com",
    databaseURL: "https://shahi-stats-analytics-1-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "shahi-stats-analytics-1",
    storageBucket: "shahi-stats-analytics-1.firebasestorage.app",
    messagingSenderId: "1079393464814",
    appId: "1:1079393464814:web:b48822af5f42aa5c91deff",
    measurementId: "G-XQ5MM7B3M5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const nav = document.getElementById("nav");
  const totalMachines = document.getElementById("totalMachines");
  const tableContainer = document.getElementById("machinesTable");
  const fields = ["owned","demo","rented","active","breakdown","idle","moving","warranty","nonWarranty","amc","nonAmc"];

  let currentDiv = null;
  let currentUnit = null;
  let currentFilter = null;
  let currentFilterLabel = null;
  let unsubscribeMachines = null;

  function updateUI(stats) {
    totalMachines.textContent = `Total Machines: ${stats.total || 0}`;
    fields.forEach(f => {
      const el = document.getElementById(f);
      if (el) el.textContent = stats[f] || 0;
    });
  }

  function clearNavActive() {
    document.querySelectorAll(".nav-card").forEach(el => el.classList.remove("nav-active"));
  }

  function buildNav(divId, unitKeys) {
    nav.innerHTML = "";
    const divCard = document.createElement("div");
    divCard.className = "nav-card";
    divCard.textContent = divId;
    divCard.onclick = () => {
      currentDiv = divId;
      currentUnit = null;
      currentFilter = null;
      currentFilterLabel = null;
      loadDiv(divId, divCard, true);
    };
    nav.appendChild(divCard);

    unitKeys.forEach(u => {
      const unitCard = document.createElement("div");
      unitCard.className = "nav-card";
      unitCard.textContent = u;
      unitCard.onclick = () => {
        currentDiv = divId;
        currentUnit = u;
        currentFilter = null;
        currentFilterLabel = null;
        loadUnit(divId, u, unitCard, true);
      };
      nav.appendChild(unitCard);
    });
  }

  function loadDiv(divId, el, autoTable = false) {
    clearNavActive();
    el.classList.add("nav-active");
    const divRef = ref(db, `divstats/div/${divId}/stats`);
    onValue(divRef, snap => {
      if (snap.exists() && !currentUnit) {
        updateUI(snap.val());
        if (autoTable && !currentFilter) {
          subscribeMachines(divId, null);
        }
      }
    });
  }

  function loadUnit(divId, unitId, el, autoTable = false) {
    clearNavActive();
    el.classList.add("nav-active");
    const unitRef = ref(db, `unitstats/div/${divId}/unit/${unitId}/stats`);
    onValue(unitRef, snap => {
      if (snap.exists() && currentUnit === unitId) {
        updateUI(snap.val());
        if (autoTable && !currentFilter) {
          subscribeMachines(divId, unitId);
        }
      }
    });
  }

  // ---- FIXED subscribeMachines ----
  function subscribeMachines(divId, unitId = null) {
    if (typeof unsubscribeMachines === "function") {
      try { unsubscribeMachines(); } catch (e) {}
      unsubscribeMachines = null;
    }

    const baseRef = unitId
      ? ref(db, `machineslist/div/${divId}/unit/${unitId}`)
      : ref(db, `machineslist/div/${divId}/unit`);

    unsubscribeMachines = onValue(baseRef, snap => {
      const rows = [];
      if (snap.exists()) {
        const unitsObj = unitId ? { [unitId]: snap.val() } : snap.val();
        Object.entries(unitsObj || {}).forEach(([uKey, uVal]) => {
          const typesObj = uVal?.type || {};
          Object.entries(typesObj).forEach(([typeName, typeVal]) => {
            const machinesObj = typeVal?.machines || {};
            Object.entries(machinesObj).forEach(([machineId, machineVal]) => {
              const d = machineVal?.data || {};
              rows.push({
                machineId,
                type: d.type || typeName || "",
                division: d.division || divId,
                unit: d.unit || uKey,
                ownership: d.ownership || "",
                status: d.status || "",
                has_amc: normalizeYesNo(d.has_amc),
                warranty: normalizeYesNo(d.warranty ?? d.has_warranty),
              });
            });
          });
        });
      }
      if (currentFilter) {
        const filtered = rows.filter(r => matchesCardFilter(r, currentFilter));
        renderTable(filtered, `${currentFilterLabel || currentFilter} (${filtered.length})`);
      } else {
        renderTable(rows, `All Machines (${rows.length})`);
      }
    });
  }

  function normalizeYesNo(v) {
    if (v === true) return "Yes";
    if (v === false) return "No";
    if (typeof v === "string") {
      const s = v.trim().toLowerCase();
      if (["yes","y","true"].includes(s)) return "Yes";
      if (["no","n","false"].includes(s)) return "No";
    }
    return null;
  }

  function matchesCardFilter(row, key) {
    switch (key) {
      case "owned": return (row.ownership || "").toLowerCase() === "owned";
      case "demo": return (row.ownership || "").toLowerCase() === "demo";
      case "rented": return (row.ownership || "").toLowerCase() === "rented";
      case "active": return (row.status || "").toLowerCase() === "active";
      case "breakdown": return (row.status || "").toLowerCase() === "breakdown";
      case "idle": return (row.status || "").toLowerCase() === "idle";
      case "moving": return (row.status || "").toLowerCase() === "moving";
      case "warranty": return row.warranty === "Yes";
      case "nonWarranty": return row.warranty === "No";
      case "amc": return row.has_amc === "Yes";
      case "nonAmc": return row.has_amc === "No";
      default: return true;
    }
  }

  function renderTable(rows, titleText) {
    if (!rows.length) {
      tableContainer.innerHTML = `
        <div class="table-wrapper">
          <div class="table-title">${titleText}</div>
          <div class="empty-state">
            <i data-lucide="list"></i>
            <p>No machines found.</p>
          </div>
        </div>`;
      lucide.createIcons();
      return;
    }
    const thead = `
      <thead><tr>
        <th>Machine ID</th><th>Type</th><th>Division</th><th>Unit</th>
        <th>Ownership</th><th>Status</th><th>AMC</th><th>Warranty</th>
      </tr></thead>`;
    const tbody = rows.map(r => `
      <tr>
        <td>${r.machineId}</td><td>${r.type}</td><td>${r.division}</td>
        <td>${r.unit}</td><td>${r.ownership}</td><td>${r.status}</td>
        <td>${r.has_amc || ""}</td><td>${r.warranty || ""}</td>
      </tr>`).join("");
    tableContainer.innerHTML = `
      <div class="table-wrapper">
        <div class="table-title">${titleText}</div>
        <div class="table-scroll"><table>${thead}<tbody>${tbody}</tbody></table></div>
      </div>`;
  }

  function handleCardClick(key, label) {
    if (!currentDiv) return;
    currentFilter = key;
    currentFilterLabel = label;
    subscribeMachines(currentDiv, currentUnit);
  }

  document.querySelectorAll(".card[data-key]").forEach(card => {
    const key = card.getAttribute("data-key");
    const label = card.querySelector(".label")?.textContent?.trim() || key;
    card.addEventListener("click", () => handleCardClick(key, label));
  });

  // Init
  const urlParams = new URLSearchParams(window.location.search);
  const defaultDiv = urlParams.get("div") || "div1";
  const unitRef = ref(db, `unitstats/div/${defaultDiv}/unit`);
  onValue(unitRef, snap => {
    const unitKeys = snap.exists() ? Object.keys(snap.val()) : [];
    buildNav(defaultDiv, unitKeys);
    const activeEl = [...nav.children].find(el => el.textContent === defaultDiv);
    if (activeEl) {
      currentDiv = defaultDiv;
      currentUnit = null;
      loadDiv(defaultDiv, activeEl, true);
    }
  });

  </script>
</body>
</html>
