<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Unit Stats Dashboard</title>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
  #dashboardTitle { font-size: 26px; font-weight: 600; margin-bottom: 10px; color: #1F3B73; }
  #totalMachines { font-size: 28px; font-weight: 500; color: #154360; margin-bottom: 20px; }
  .stats-grid { display: flex; flex-direction: column; gap: 15px; }
  .row { display: flex; gap: 15px; justify-content: flex-start; padding: 12px; border-radius: 10px; border: 1px solid #e0e0e0; background: #fff; }
  .card { flex: 1; padding: 15px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; 
    box-shadow: 0px 2px 6px rgba(0,0,0,0.1); transition: transform 0.2s ease; cursor: pointer; 
    color: #fff; }
  .card:hover { transform: scale(1.05); }
  .card .label { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 500; }
  .card span { font-size: 34px; font-weight: 500; }

  /* Top Row */
.owned { background:#5A6ACF; color:white; }      /* Blue */
.demo { background:#5A6ACF; color:white; }       /* Blue */
.rented { background:#5A6ACF; color:white; }     /* Blue */

/* Status Row */
.active { background:#7BA289; color:white; }     /* Green */
.breakdown { background:#7BA289; color:white; }  /* Green */
.idle { background:#7BA289; color:white; }       /* Green */
.moving { background:#7BA289; color:white; }     /* Green */

/* Bottom Row */
.warranty { background:#7E8587; color:white; }   /* Gray */
.nonwarranty { background:#7E8587; color:white; }/* Gray */
.amc { background:#7E8587; color:white; }        /* Gray */
.nonamc { background:#7E8587; color:white; }     /* Gray */

  /* Table */
  .table-wrapper { margin-top: 18px; background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0px 2px 6px rgba(0,0,0,0.08); }
  .table-title { padding: 12px 16px; font-weight: 600; color: #154360; border-bottom: 1px solid #e5e7eb; }
  .table-scroll { max-height: 400px; overflow-y: auto; }
  .machines-table { width: 100%; border-collapse: separate; border-spacing: 0; }
  .machines-table th, .machines-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; white-space: nowrap; }
  .machines-table thead th { background: #f9fafb; font-weight: 700; position: sticky; top: 0; z-index: 2; }
  .machines-table tr:hover { background: #f8fafc; }
  .empty-state { display: flex; align-items: center; gap: 10px; padding: 14px 16px; color: #6b7280; }
</style>
</head>
<body>
<h2 id="dashboardTitle">Unit: <span id="unitLabel"></span></h2>
<div id="totalMachines">Total Machines: 0</div>

<!-- Stats -->
<div class="stats-grid">
  <div class="row ownership">
    <div class="card owned" data-key="owned"><div class="label"><i data-lucide="factory"></i> Owned</div><span id="owned">0</span></div>
    <div class="card demo" data-key="demo"><div class="label"><i data-lucide="presentation"></i> Demo</div><span id="demo">0</span></div>
    <div class="card rented" data-key="rented"><div class="label"><i data-lucide="calendar-clock"></i> Rented</div><span id="rented">0</span></div>
  </div>
  <div class="row status">
    <div class="card active" data-key="active"><div class="label"><i data-lucide="zap"></i> Active</div><span id="active">0</span></div>
    <div class="card breakdown" data-key="breakdown"><div class="label"><i data-lucide="wrench"></i> Breakdown</div><span id="breakdown">0</span></div>
    <div class="card idle" data-key="idle"><div class="label"><i data-lucide="power"></i> Idle</div><span id="idle">0</span></div>
    <div class="card moving" data-key="moving"><div class="label"><i data-lucide="truck"></i> Moving</div><span id="moving">0</span></div>
  </div>
  <div class="row other">
    <div class="card warranty" data-key="warranty"><div class="label"><i data-lucide="shield-check"></i> Warranty</div><span id="warranty">0</span></div>
    <div class="card nonwarranty" data-key="nonWarranty"><div class="label"><i data-lucide="shield-x"></i> Non-Warranty</div><span id="nonWarranty">0</span></div>
    <div class="card amc" data-key="amc"><div class="label"><i data-lucide="settings"></i> AMC</div><span id="amc">0</span></div>
    <div class="card nonamc" data-key="nonAmc"><div class="label"><i data-lucide="settings-x"></i> Non-AMC</div><span id="nonAmc">0</span></div>
  </div>
</div>

<!-- Machines table -->
<div id="machinesTable"></div>

<!-- Firebase Script -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAnHHfwRgKh_Ff1RNmIzf8MYZEMrFsyx2Q",
  authDomain: "shahi-stats-analytics-1.firebaseapp.com",
  databaseURL: "https://shahi-stats-analytics-1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shahi-stats-analytics-1",
  storageBucket: "shahi-stats-analytics-1.firebasestorage.app",
  messagingSenderId: "1079393464814",
  appId: "1:1079393464814:web:b48822af5f42aa5c91deff",
  measurementId: "G-XQ5MM7B3M5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const unitId = new URLSearchParams(window.location.search).get("unit") || "1G";
const divId = new URLSearchParams(window.location.search).get("div") || "MNB";
document.getElementById("unitLabel").textContent = unitId;

const fields = ["owned","demo","rented","active","breakdown","idle","moving","warranty","nonWarranty","amc","nonAmc"];
const totalMachines = document.getElementById("totalMachines");

// Update UI
function updateUI(stats) {
  totalMachines.textContent = `Total Machines: ${stats.total || 0}`;
  fields.forEach(f => {
    const el = document.getElementById(f);
    if(el) el.textContent = stats[f] || 0;
  });
}

// Firebase listener for stats
const unitRef = ref(db, `unitstats/div/${divId}/unit/${unitId}/stats`);
onValue(unitRef, snap => {
  if (snap.exists()) updateUI(snap.val());
});

// --- FIXED: Table + Filters ---
async function fetchMachines() {
  // Fixed path to match your Firebase structure
  const baseRef = ref(db, `machineslist/div/${divId}/unit/${unitId}/type/machines`);
  const snap = await get(baseRef);
  const rows = [];
  
  console.log("Firebase data:", snap.val()); // Debug log
  
  if (snap.exists()) {
    const machinesObj = snap.val() || {};
    // Direct iteration over machines since we're already at the machines level
    Object.entries(machinesObj).forEach(([machineId, machineData]) => {
      const d = machineData?.data || {};
      rows.push({
        machineId,
        type: (d.type || "").replace(/,/g,"."),
        division: d.division || divId,
        unit: d.unit || unitId,
        ownership: d.ownership || "",
        status: d.status || "",
        has_amc: normalizeYesNo(d.has_amc),
        warranty: normalizeYesNo(d.has_warranty || d.warranty),
      });
    });
  }
  
  console.log("Processed rows:", rows); // Debug log
  return rows;
}

function normalizeYesNo(v) {
  if (v === true) return "Yes";
  if (v === false) return "No";
  if (typeof v === "string") {
    const s = v.trim().toLowerCase();
    if (["yes","y","true"].includes(s)) return "Yes";
    if (["no","n","false"].includes(s)) return "No";
  }
  return "";
}

function matchesCardFilter(row, key) {
  switch (key) {
    case "owned":     return (row.ownership || "").toLowerCase() === "owned";
    case "demo":      return (row.ownership || "").toLowerCase() === "demo";
    case "rented":    return (row.ownership || "").toLowerCase() === "rented";
    case "active":    return (row.status || "").toLowerCase() === "active";
    case "breakdown": return (row.status || "").toLowerCase() === "breakdown";
    case "idle":      return (row.status || "").toLowerCase() === "idle";
    case "moving":    return (row.status || "").toLowerCase() === "moving";
    case "warranty":     return row.warranty === "Yes";
    case "nonWarranty":  return row.warranty === "No";
    case "amc":          return row.has_amc === "Yes";
    case "nonAmc":       return row.has_amc === "No";
    default: return true;
  }
}

function renderTable(rows, titleText) {
  const container = document.getElementById("machinesTable");
  if (!rows.length) {
    container.innerHTML = `
      <div class="table-wrapper">
        <div class="table-title">${titleText}</div>
        <div class="empty-state">
          <i data-lucide="list"></i>
          <p>No machines found for "${titleText}".</p>
        </div>
      </div>`;
    lucide.createIcons();
    return;
  }
  const thead = `
    <thead>
      <tr>
        <th>Machine ID</th>
        <th>Type</th>
        <th>Division</th>
        <th>Unit</th>
        <th>Ownership</th>
        <th>Status</th>
        <th>AMC</th>
        <th>Warranty</th>
      </tr>
    </thead>`;
  const tbody = rows.map(r => `
    <tr>
      <td>${escapeHtml(r.machineId)}</td>
      <td>${escapeHtml(r.type)}</td>
      <td>${escapeHtml(r.division)}</td>
      <td>${escapeHtml(r.unit)}</td>
      <td>${escapeHtml(r.ownership)}</td>
      <td>${escapeHtml(r.status)}</td>
      <td>${escapeHtml(r.has_amc)}</td>
      <td>${escapeHtml(r.warranty)}</td>
    </tr>`).join("");
  container.innerHTML = `
    <div class="table-wrapper">
      <div class="table-title">${titleText}</div>
      <div class="table-scroll">
        <table class="machines-table">${thead}<tbody>${tbody}</tbody></table>
      </div>
    </div>`;
}

function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

async function handleCardClick(key, label) {
  const rows = await fetchMachines();
  const filtered = rows.filter(r => matchesCardFilter(r, key));
  const titleText = `${label} — Unit ${unitId} (${filtered.length})`;
  renderTable(filtered, titleText);
}

// Load all machines on page load
async function loadAllMachines() {
  const rows = await fetchMachines();
  renderTable(rows, `All Machines — Unit ${unitId} (${rows.length})`);
}

// Attach click listeners
document.querySelectorAll(".card[data-key]").forEach(card => {
  const key = card.getAttribute("data-key");
  const label = card.querySelector(".label")?.textContent?.trim() || key;
  card.addEventListener("click", () => handleCardClick(key, label));
});

// Load icons and initial data
lucide.createIcons();
loadAllMachines(); // Load table on page load
</script>
</body>
</html>
